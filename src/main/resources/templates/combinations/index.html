<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Kolors - Combinaciones de Colores</title>
   <link rel="stylesheet" th:href="@{/css/mobile-responsive.css}">
   <link rel="stylesheet" th:href="@{/css/theme.css}">
   <style>
      /* Additional styles specific to index page */

      /* Alert color overrides */
      .alert-success {
         background-color: #d4edda;
         color: #155724;
         border: 1px solid #c3e6cb;
      }

      .alert-error {
         background-color: #f8d7da;
         color: #721c24;
         border: 1px solid #f5c6cb;
      }

      .form-control.error {
         border-color: #dc3545;
      }

      /* Dynamic Color Fields - mobile optimizations */
      #dynamicColorFields {
         margin-top: 15px;
      }

      /* Mobile-specific color field adjustments */
      @media (max-width: 767px) {
         .color-field {
            padding: 20px 15px;
         }

         .color-preview {
            width: 70px;
            height: 70px;
         }

         .color-input {
            font-size: 18px; /* Prevent zoom on iOS */
         }

         .remove-color-btn {
            width: 48px;
            height: 48px;
            font-size: 20px;
         }
      }

      /* Live Preview mobile optimizations */
      .live-preview h3 {
         margin-bottom: 15px;
         color: #495057;
         text-align: center;
      }

      /* Mobile preview adjustments */
      @media (max-width: 767px) {
         .preview-color {
            width: 45px;
            height: 45px;
         }

         .preview-name {
            margin-left: 0;
            margin-top: 10px;
            font-size: 1.1rem;
         }
      }

      /* Button color overrides */
      .btn-primary {
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
      }

      .btn-primary:hover {
         transform: translateY(-2px);
         box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
         background: #6c757d;
         color: white;
      }

      .btn-danger {
         background: #dc3545;
         color: white;
      }

      /* Mobile button optimizations */
      @media (max-width: 767px) {
         .btn {
            padding: 16px 20px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
         }

         .btn-sm {
            padding: 12px 16px;
            font-size: 15px;
         }

         #addColorBtn {
            width: 100%;
            margin-bottom: 10px;
         }
      }

      /* Combinations section mobile optimizations */
      .combinations-section {
         margin-top: 20px;
      }

      .combinations-section h2 {
         color: #495057;
         margin-bottom: 15px;
         font-size: 1.3rem;
         text-align: center;
      }

      /* Search and filter styles */
      .search-filters {
         background: #f8f9fa;
         border-radius: 8px;
         padding: 20px;
         margin-bottom: 20px;
      }

      .search-row {
         display: flex;
         gap: 15px;
         flex-wrap: wrap;
         align-items: end;
      }

      .search-row .form-group {
         flex: 1;
         min-width: 200px;
      }

      .advanced-filters {
         margin-top: 15px;
         padding-top: 15px;
         border-top: 1px solid #dee2e6;
      }

      .search-actions {
         display: flex;
         gap: 10px;
         margin-top: 15px;
         flex-wrap: wrap;
      }

      .search-results-info {
         margin-bottom: 15px;
         padding: 10px 15px;
         background: #e9ecef;
         border-radius: 5px;
      }

      .results-count {
         margin: 0;
         color: #495057;
         font-size: 0.9rem;
      }

      .search-term, .filter-info {
         color: #007bff;
      }

      /* Pagination styles */
      .pagination-controls {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-top: 20px;
         padding: 15px;
         background: #f8f9fa;
         border-radius: 8px;
      }

      .pagination-info {
         color: #6c757d;
         font-size: 0.9rem;
      }

      .pagination-buttons {
         display: flex;
         gap: 5px;
         align-items: center;
      }

      .pagination-buttons .current-page {
         background: #007bff !important;
         border-color: #007bff !important;
      }

      /* Mobile search optimizations */
      @media (max-width: 767px) {
         .combinations-section h2 {
            font-size: 1.2rem;
         }

         .search-filters {
            padding: 15px;
         }

         .search-row {
            flex-direction: column;
            gap: 10px;
         }

         .search-row .form-group {
            min-width: auto;
         }

         .search-actions {
            flex-direction: column;
         }

         .pagination-controls {
            flex-direction: column;
            gap: 10px;
         }

         .pagination-buttons {
            flex-wrap: wrap;
            justify-content: center;
         }
      }

      .combination-name {
         font-size: 1.1rem;
         font-weight: 600;
         color: #495057;
         margin-bottom: 10px;
         text-align: center;
      }

      .combination-meta {
         font-size: 0.85rem;
         color: #6c757d;
         margin-bottom: 10px;
         text-align: center;
      }

      /* Mobile combination card optimizations */
      @media (max-width: 767px) {
         .combination-name {
            font-size: 1rem;
         }

         .combination-meta {
            font-size: 0.8rem;
         }

         .combination-colors {
            justify-content: center;
            margin-bottom: 20px;
         }

         .combination-color {
            width: 32px;
            height: 32px;
         }

         .combination-color::after {
            font-size: 8px;
            bottom: -16px;
         }
      }

      /* Error Messages */
      .field-error {
         color: #dc3545;
         font-size: 0.875rem;
         margin-top: 5px;
         text-align: center;
      }

      /* Mobile statistics optimizations */
      @media (max-width: 767px) {
         .stat-number {
            font-size: 1.5rem;
         }

         .stat-label {
            font-size: 0.85rem;
         }
      }

      /* Touch interaction improvements */
      @media (max-width: 767px) {
         /* Increase touch targets */
         .form-control {
            padding: 16px 14px;
            font-size: 16px; /* Prevent zoom on iOS */
         }

         /* Improve color field interactions */
         .color-field {
            padding: 20px;
            margin-bottom: 20px;
         }

         /* Better spacing for mobile */
         .form-group {
            margin-bottom: 20px;
         }

         /* Optimize search form for mobile */
         .search-row .form-group {
            margin-bottom: 15px;
         }

         /* Improve button spacing */
         .action-buttons {
            gap: 15px;
         }
      }

      /* Very small screens */
      @media (max-width: 480px) {
         .container {
            margin: 5px;
         }

         .content {
            padding: 15px;
         }

         .form-section {
            padding: 15px;
         }

         .combination-card {
            padding: 15px;
         }
      }

      /* Copy to clipboard functionality */
      .combination-color {
         cursor: pointer;
         transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .combination-color:hover {
         transform: scale(1.1);
         box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
      }

      .combination-color:active {
         transform: scale(0.95);
      }

      /* Toast notification */
      .toast {
         position: fixed;
         bottom: 30px;
         left: 50%;
         transform: translateX(-50%) translateY(100px);
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
         padding: 12px 24px;
         border-radius: 25px;
         box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
         z-index: 1000;
         font-size: 0.95rem;
         font-weight: 500;
         opacity: 0;
         transition: all 0.3s ease;
         white-space: nowrap;
      }

      .toast.show {
         transform: translateX(-50%) translateY(0);
         opacity: 1;
      }

      /* Mobile toast adjustments */
      @media (max-width: 767px) {
         .toast {
            bottom: 20px;
            padding: 10px 20px;
            font-size: 0.9rem;
            max-width: 90%;
            white-space: normal;
            text-align: center;
         }
      }
   </style>
</head>

<body>
   <div class="container">
      <div class="header">
         <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema" aria-label="Cambiar tema">
            <span class="icon">🌙</span>
         </button>
         <h1>Kolors</h1>
         <p>Crea y gestiona tus combinaciones de colores perfectas</p>
      </div>

      <div class="content">
         <!-- Success/Error Messages -->
         <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
         <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

         <!-- Create New Combination Form -->
         <div class="form-section">
            <h2>Crear Nueva Combinación</h2>
            <form th:action="@{/combinations/create}" method="post" id="combinationForm">

               <!-- Name Field -->
               <div class="form-group">
                  <label for="name">Nombre de la Combinación</label>
                  <input type="text" name="name" class="form-control" id="name"
                     placeholder="Ej: Atardecer tropical, Océano profundo..." maxlength="100" required>
               </div>

               <!-- Dynamic Color Fields -->
               <div class="form-group">
                  <label>Colores de la Combinación</label>
                  <div id="dynamicColorFields">
                     <!-- Colors will be added dynamically here -->
                  </div>
                  <div class="color-actions">
                     <button type="button" class="btn btn-secondary btn-sm" id="addColorBtn">
                        + Agregar Color
                     </button>
                     <span class="color-count-info">
                        Colores: <span id="colorCountDisplay">1</span>
                     </span>
                  </div>
               </div>

               <!-- Live Preview -->
               <div class="live-preview" id="livePreview" style="display: none;">
                  <h3>Vista Previa</h3>
                  <div class="preview-combination">
                     <div id="livePreviewColors"></div>
                     <span class="preview-name" id="livePreviewName">Nombre de la combinación</span>
                  </div>
               </div>

               <!-- Submit Button -->
               <button type="submit" class="btn btn-primary">Crear Combinación</button>
            </form>
         </div>

         <!-- Search and Filter Section -->
         <div class="combinations-section">
            <h2>Combinaciones Guardadas</h2>

            <!-- Statistics -->
            <div class="statistics" th:if="${totalCombinations != null}">
               <div class="stat-card">
                  <div class="stat-number" th:text="${totalCombinations}">0</div>
                  <div class="stat-label">Total Combinaciones</div>
               </div>
            </div>

            <!-- Search Filters -->
            <div class="search-filters">
               <form th:action="@{/combinations/}" method="get" id="searchForm">
                  <div class="search-row">
                     <div class="form-group">
                        <label for="search">Buscar por nombre</label>
                        <input type="text" name="search" th:value="${search}" class="form-control" id="search"
                           placeholder="Buscar combinaciones...">
                     </div>
                     <div class="form-group">
                        <label for="colorCountFilter">Filtrar por número de colores</label>
                        <select name="colorCount" class="form-control" id="colorCountFilter">
                           <option value="">Todos</option>
                           <option value="1" th:selected="${colorCount == 1}">1 Color</option>
                           <option value="2" th:selected="${colorCount == 2}">2 Colores</option>
                           <option value="3" th:selected="${colorCount == 3}">3 Colores</option>
                           <option value="4" th:selected="${colorCount == 4}">4 Colores</option>
                           <option value="5" th:selected="${colorCount == 5}">5 Colores</option>
                           <option value="6" th:selected="${colorCount == 6}">6 Colores</option>
                           <option value="7" th:selected="${colorCount == 7}">7+ Colores</option>
                        </select>
                     </div>
                     <div class="form-group">
                        <label for="hexValue">Buscar por color (HEX)</label>
                        <input type="text" name="hexValue" th:value="${hexValue}" class="form-control" id="hexValue"
                           placeholder="FF5733" maxlength="6">
                     </div>
                  </div>

                  <!-- Advanced Filters -->
                  <div class="advanced-filters" id="advancedFilters" style="display: none;">
                     <div class="search-row">
                        <div class="form-group">
                           <label for="minColors">Mínimo de colores</label>
                           <input type="number" name="minColors" th:value="${minColors}" class="form-control" id="minColors"
                              min="1" max="20" placeholder="1">
                        </div>
                        <div class="form-group">
                           <label for="maxColors">Máximo de colores</label>
                           <input type="number" name="maxColors" th:value="${maxColors}" class="form-control" id="maxColors"
                              min="1" max="20" placeholder="10">
                        </div>
                     </div>
                  </div>

                  <div class="search-actions">
                     <button type="submit" class="btn btn-secondary">Buscar</button>
                     <button type="button" class="btn btn-secondary btn-sm" id="toggleAdvanced">
                        Filtros Avanzados
                     </button>
                     <button type="button" class="btn btn-secondary btn-sm" id="clearFilters">
                        Limpiar
                     </button>
                  </div>
               </form>
            </div>

            <!-- Search Results Info -->
            <div class="search-results-info" th:if="${totalCombinations != null}">
               <p class="results-count">
                  <span th:text="${totalCombinations}">0</span> combinaciones encontradas
                  <span th:if="${search != null and !search.isEmpty()}" class="search-term">
                     para "<strong th:text="${search}"></strong>"
                  </span>
                  <span th:if="${colorCount != null}" class="filter-info">
                     con <strong th:text="${colorCount}"></strong> colores
                  </span>
                  <span th:if="${minColors != null and maxColors != null}" class="filter-info">
                     con <strong th:text="${minColors}"></strong> a <strong th:text="${maxColors}"></strong> colores
                  </span>
                  <span th:if="${hexValue != null and !hexValue.isEmpty()}" class="filter-info">
                     conteniendo color <strong th:text="'#' + ${hexValue}"></strong>
                  </span>
               </p>
            </div>

            <!-- Combinations Grid -->
            <div class="combinations-grid" th:if="${combinations != null and !combinations.empty}">
               <div class="combination-card" th:each="combination : ${combinations}">
                  <div class="combination-name" th:text="${combination.name}">Nombre</div>
                  <div class="combination-meta">
                     <span th:text="${combination.colorCount}">2</span> colores •
                     <span th:text="${#temporals.format(combination.createdAt, 'dd/MM/yyyy')}">01/01/2024</span>
                  </div>
                  <div class="combination-colors">
                     <div class="combination-color" th:each="color : ${combination.colors}"
                        th:style="'background-color: #' + ${color.hexValue}"
                        th:data-hex="${'#' + color.hexValue}"
                        onclick="copyColorToClipboard(this.dataset.hex)"
                        title="Haz clic para copiar">
                     </div>
                  </div>
                  <div class="combination-actions">
                     <a th:href="@{/combinations/{id}(id=${combination.id})}" class="btn btn-secondary btn-sm">Ver</a>
                     <a th:href="@{/combinations/{id}/edit(id=${combination.id})}"
                        class="btn btn-secondary btn-sm">Editar</a>
                     <a th:href="@{/combinations/{id}/confirm-delete(id=${combination.id})}"
                        class="btn btn-danger btn-sm">Eliminar</a>
                  </div>
               </div>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls" th:if="${totalPages != null and totalPages > 1}">
               <div class="pagination-info">
                  Página <span th:text="${currentPage + 1}">1</span> de <span th:text="${totalPages}">1</span>
               </div>
               <div class="pagination-buttons">
                  <a th:if="${hasPrevious}"
                     th:href="@{/combinations/paginated(search=${search}, colorCount=${colorCount}, minColors=${minColors}, maxColors=${maxColors}, hexValue=${hexValue}, page=${currentPage - 1}, size=${pageSize})}"
                     class="btn btn-secondary btn-sm">« Anterior</a>

                  <span th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                        th:if="${pageNum >= (currentPage - 2) and pageNum <= (currentPage + 2)}">
                     <a th:if="${pageNum != currentPage}"
                        th:href="@{/combinations/paginated(search=${search}, colorCount=${colorCount}, minColors=${minColors}, maxColors=${maxColors}, hexValue=${hexValue}, page=${pageNum}, size=${pageSize})}"
                        th:text="${pageNum + 1}"
                        class="btn btn-secondary btn-sm">1</a>
                     <span th:if="${pageNum == currentPage}"
                           th:text="${pageNum + 1}"
                           class="btn btn-primary btn-sm current-page">1</span>
                  </span>

                  <a th:if="${hasNext}"
                     th:href="@{/combinations/paginated(search=${search}, colorCount=${colorCount}, minColors=${minColors}, maxColors=${maxColors}, hexValue=${hexValue}, page=${currentPage + 1}, size=${pageSize})}"
                     class="btn btn-secondary btn-sm">Siguiente »</a>
               </div>
            </div>

            <!-- Empty State -->
            <div th:if="${combinations == null or combinations.empty}" class="text-center" style="padding: 40px;">
               <h3 style="color: #6c757d; margin-bottom: 10px;">No hay combinaciones guardadas</h3>
               <p style="color: #6c757d;" th:if="${search == null and colorCount == null and hexValue == null}">
                  Crea tu primera combinación de colores usando el formulario de arriba.
               </p>
               <p style="color: #6c757d;" th:if="${search != null or colorCount != null or hexValue != null}">
                  No se encontraron combinaciones que coincidan con los criterios de búsqueda.
                  <a href="/combinations/" class="btn btn-secondary btn-sm" style="margin-left: 10px;">Ver todas</a>
               </p>
            </div>
         </div>
      </div>
   </div>

   <!-- Toast Notification -->
   <div id="toast" class="toast"></div>

   <script>
      // Theme Management - Load theme before page renders
      (function() {
         const savedTheme = localStorage.getItem('kolors-theme') || 'light';
         document.documentElement.setAttribute('data-theme', savedTheme);
         updateThemeIcon(savedTheme);
      })();

      function toggleTheme() {
         const currentTheme = document.documentElement.getAttribute('data-theme');
         const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

         // Apply theme
         document.documentElement.setAttribute('data-theme', newTheme);

         // Save to localStorage
         localStorage.setItem('kolors-theme', newTheme);

         // Update icon
         updateThemeIcon(newTheme);

         // Haptic feedback if available
         if (navigator.vibrate) {
            navigator.vibrate(50);
         }
      }

      function updateThemeIcon(theme) {
         const icon = document.querySelector('.theme-toggle .icon');
         if (icon) {
            icon.textContent = theme === 'dark' ? '☀️' : '🌙';
         }
      }

      // Copy color to clipboard functionality
      function copyColorToClipboard(hexValue) {
         const text = hexValue.startsWith('#') ? hexValue : '#' + hexValue;

         // Try modern clipboard API
         if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
               showToast('Color ' + text + ' copiado!');

               // Haptic feedback if available
               if (navigator.vibrate) {
                  navigator.vibrate(50);
               }
            }).catch(function(err) {
               console.error('Error al copiar: ', err);
               fallbackCopyToClipboard(text);
            });
         } else {
            // Fallback for older browsers
            fallbackCopyToClipboard(text);
         }
      }

      // Fallback copy method for older browsers
      function fallbackCopyToClipboard(text) {
         const textArea = document.createElement('textarea');
         textArea.value = text;
         textArea.style.position = 'fixed';
         textArea.style.left = '-9999px';
         textArea.style.top = '-9999px';
         document.body.appendChild(textArea);
         textArea.focus();
         textArea.select();

         try {
            const successful = document.execCommand('copy');
            if (successful) {
               showToast('Color ' + text + ' copiado!');

               // Haptic feedback if available
               if (navigator.vibrate) {
                  navigator.vibrate(50);
               }
            } else {
               showToast('No se pudo copiar el color', 'error');
            }
         } catch (err) {
            console.error('Fallback copy failed: ', err);
            showToast('No se pudo copiar el color', 'error');
         }

         document.body.removeChild(textArea);
      }

      // Show toast notification
      function showToast(message, type = 'success') {
         const toast = document.getElementById('toast');
         toast.textContent = message;

         // Change color based on type
         if (type === 'error') {
            toast.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
         } else {
            toast.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
         }

         toast.classList.add('show');

         setTimeout(() => {
            toast.classList.remove('show');
         }, 3000);
      }

      // Dynamic Color Combination Management
      document.addEventListener('DOMContentLoaded', function () {
         const dynamicColorFields = document.getElementById('dynamicColorFields');
         const addColorBtn = document.getElementById('addColorBtn');
         const colorCountDisplay = document.getElementById('colorCountDisplay');
         const livePreview = document.getElementById('livePreview');
         const nameInput = document.getElementById('name');

         let colorCount = 0;
         let colorIndex = 0;

         // Initialize with one color
         addColor();

         // Add color button event
         addColorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addColor();
         });

         // Add new color field
         function addColor(hexValue = '', position = null) {
            colorCount++;
            const actualPosition = position || colorCount;
            const fieldIndex = colorIndex++;

            const colorField = document.createElement('div');
            colorField.className = 'color-field';
            colorField.dataset.position = actualPosition;
            colorField.innerHTML = `
               <span class="color-label">Color ${actualPosition}:</span>
               <div class="color-preview" id="preview-${fieldIndex}"></div>
               <input type="text"
                      name="colors[${actualPosition - 1}].hexValue"
                      class="form-control color-input"
                      placeholder="FF5733"
                      maxlength="6"
                      data-position="${actualPosition}"
                      data-index="${fieldIndex}"
                      value="${hexValue}">
               <input type="hidden"
                      name="colors[${actualPosition - 1}].position"
                      value="${actualPosition}">
               <button type="button"
                       class="remove-color-btn"
                       onclick="removeColor(this)"
                       ${colorCount === 1 ? 'disabled' : ''}>×</button>
            `;

            dynamicColorFields.appendChild(colorField);
            updateColorCountDisplay();

            // Set up event listeners for the new input
            const colorInput = colorField.querySelector('.color-input');
            setupColorInput(colorInput);

            // If hex value provided, update preview
            if (hexValue && hexValue.length === 6) {
               updateColorPreview(fieldIndex, hexValue);
            }

            updateLivePreview();
         }

         // Remove color field
         window.removeColor = function(button) {
            if (colorCount <= 1) return;

            const colorField = button.closest('.color-field');
            colorField.remove();
            colorCount--;

            // Reorder remaining fields
            reorderColorFields();
            updateColorCountDisplay();
            updateLivePreview();
         };

         // Reorder color fields after removal
         function reorderColorFields() {
            const fields = dynamicColorFields.querySelectorAll('.color-field');
            fields.forEach((field, index) => {
               const position = index + 1;
               const label = field.querySelector('.color-label');
               const hexInput = field.querySelector('input[type="text"]');
               const positionInput = field.querySelector('input[type="hidden"]');
               const removeBtn = field.querySelector('.remove-color-btn');

               // Update labels and names
               label.textContent = `Color ${position}:`;
               hexInput.name = `colors[${index}].hexValue`;
               hexInput.dataset.position = position;
               positionInput.name = `colors[${index}].position`;
               positionInput.value = position;
               field.dataset.position = position;

               // Disable remove button if only one color
               removeBtn.disabled = colorCount === 1;
            });
         }

         // Set up color input event listeners
         function setupColorInput(input) {
            input.addEventListener('input', function(e) {
               const value = e.target.value.toUpperCase();
               const isValid = /^[0-9A-F]{0,6}$/.test(value);

               if (isValid) {
                  e.target.value = value;
                  e.target.classList.remove('error');

                  const fieldIndex = e.target.dataset.index;
                  if (value.length === 6) {
                     updateColorPreview(fieldIndex, value);
                  } else {
                     clearColorPreview(fieldIndex);
                  }
               } else {
                  e.target.classList.add('error');
               }

               updateLivePreview();
            });
         }

         // Update color preview
         function updateColorPreview(fieldIndex, hexValue) {
            const preview = document.getElementById(`preview-${fieldIndex}`);
            if (preview) {
               preview.style.backgroundColor = '#' + hexValue;
               preview.style.borderColor = '#' + hexValue;
            }
         }

         // Clear color preview
         function clearColorPreview(fieldIndex) {
            const preview = document.getElementById(`preview-${fieldIndex}`);
            if (preview) {
               preview.style.backgroundColor = '#f8f9fa';
               preview.style.borderColor = '#e9ecef';
            }
         }

         // Update color count display
         function updateColorCountDisplay() {
            colorCountDisplay.textContent = colorCount;
         }

         // Update live preview
         function updateLivePreview() {
            const name = nameInput.value.trim();
            const colorInputs = dynamicColorFields.querySelectorAll('.color-input');
            const validColors = [];

            colorInputs.forEach(input => {
               const value = input.value.trim();
               if (value.length === 6 && /^[0-9A-F]{6}$/.test(value)) {
                  validColors.push(value);
               }
            });

            if (name && validColors.length > 0) {
               livePreview.style.display = 'block';
               document.getElementById('livePreviewName').textContent = name;

               const previewColorsContainer = document.getElementById('livePreviewColors');
               previewColorsContainer.innerHTML = '';

               validColors.forEach(color => {
                  const colorDiv = document.createElement('div');
                  colorDiv.className = 'preview-color';
                  colorDiv.style.backgroundColor = '#' + color;
                  colorDiv.title = '#' + color;
                  previewColorsContainer.appendChild(colorDiv);
               });
            } else {
               livePreview.style.display = 'none';
            }
         }

         // Name input listener
         nameInput.addEventListener('input', updateLivePreview);

         // Form validation
         document.getElementById('combinationForm').addEventListener('submit', function (e) {
            const name = nameInput.value.trim();

            if (!name || name.length < 3) {
               e.preventDefault();
               alert('El nombre debe tener al menos 3 caracteres');
               nameInput.focus();
               return;
            }

            if (colorCount < 1) {
               e.preventDefault();
               alert('Debe tener al menos un color');
               return;
            }

            const colorInputs = dynamicColorFields.querySelectorAll('.color-input');
            let validColorCount = 0;

            for (let i = 0; i < colorInputs.length; i++) {
               const input = colorInputs[i];
               const value = input.value.trim();

               if (!value || value.length !== 6 || !/^[0-9A-F]{6}$/.test(value)) {
                  e.preventDefault();
                  alert(`Color ${i + 1} tiene formato inválido. Use 6 caracteres hexadecimales (0-9, A-F)`);
                  input.focus();
                  return;
               }
               validColorCount++;
            }

            if (validColorCount !== colorCount) {
               e.preventDefault();
               alert('Debe completar todos los colores');
               return;
            }
         });

         // Search functionality
         const searchForm = document.getElementById('searchForm');
         const searchInput = document.getElementById('search');
         const colorCountFilter = document.getElementById('colorCountFilter');
         const hexValueInput = document.getElementById('hexValue');
         const minColorsInput = document.getElementById('minColors');
         const maxColorsInput = document.getElementById('maxColors');
         const toggleAdvancedBtn = document.getElementById('toggleAdvanced');
         const clearFiltersBtn = document.getElementById('clearFilters');
         const advancedFilters = document.getElementById('advancedFilters');

         // Auto-submit search on input change (debounced)
         let searchTimeout;
         function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
               searchForm.submit();
            }, 500);
         }

         // Search input listeners
         searchInput.addEventListener('input', debounceSearch);
         colorCountFilter.addEventListener('change', () => {
            // Clear range filters when specific count is selected
            if (colorCountFilter.value) {
               minColorsInput.value = '';
               maxColorsInput.value = '';
            }
            searchForm.submit();
         });

         // Range filter listeners
         minColorsInput.addEventListener('input', function() {
            if (this.value) {
               colorCountFilter.value = ''; // Clear specific count when range is used
            }
            debounceSearch();
         });

         maxColorsInput.addEventListener('input', function() {
            if (this.value) {
               colorCountFilter.value = ''; // Clear specific count when range is used
            }
            debounceSearch();
         });

         // Hex value validation in search
         hexValueInput.addEventListener('input', function (e) {
            const value = e.target.value.toUpperCase();
            const isValid = /^[0-9A-F]{0,6}$/.test(value);

            if (isValid) {
               e.target.value = value;
               e.target.classList.remove('error');
               if (value.length === 6) {
                  debounceSearch();
               }
            } else {
               e.target.classList.add('error');
            }
         });

         // Toggle advanced filters
         toggleAdvancedBtn.addEventListener('click', function() {
            const isVisible = advancedFilters.style.display !== 'none';
            advancedFilters.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? 'Filtros Avanzados' : 'Ocultar Filtros';
         });

         // Clear all filters
         clearFiltersBtn.addEventListener('click', function() {
            searchInput.value = '';
            colorCountFilter.value = '';
            hexValueInput.value = '';
            minColorsInput.value = '';
            maxColorsInput.value = '';
            searchForm.submit();
         });

         // Validate range inputs
         function validateRange() {
            const min = parseInt(minColorsInput.value);
            const max = parseInt(maxColorsInput.value);

            if (min && max && min > max) {
               maxColorsInput.setCustomValidity('El máximo debe ser mayor o igual al mínimo');
            } else {
               maxColorsInput.setCustomValidity('');
            }
         }

         minColorsInput.addEventListener('change', validateRange);
         maxColorsInput.addEventListener('change', validateRange);
      });
   </script>

   <!-- Mobile Enhancement JavaScript -->
   <script th:src="@{/js/mobile-enhancements.js}"></script>
</body>

</html>
