<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Editar Combinación - Kolors</title>
   <link rel="stylesheet" th:href="@{/css/mobile-responsive.css}">
   <style>
      /* Edit page specific styles */
      .container {
         max-width: 800px;
      }

      /* Alert overrides */
      .alert-success {
         background-color: #d4edda;
         color: #155724;
         border: 1px solid #c3e6cb;
      }

      .alert-error {
         background-color: #f8d7da;
         color: #721c24;
         border: 1px solid #f5c6cb;
      }

      .form-control.error {
         border-color: #dc3545;
      }

      .color-count-display {
         background: #667eea;
         color: white;
         padding: 10px 20px;
         border-radius: 8px;
         display: inline-block;
         font-weight: 600;
         margin-bottom: 20px;
         text-align: center;
         width: 100%;
      }

      /* Mobile optimizations for edit page */
      @media (max-width: 767px) {
         .color-count-display {
            padding: 12px 16px;
            font-size: 1rem;
         }

         .color-field {
            padding: 20px 15px;
         }

         .color-preview {
            width: 60px;
            height: 60px;
         }

         .color-input {
            font-size: 16px; /* Prevent zoom on iOS */
         }
      }

      /* Button overrides */
      .btn-primary {
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         color: white;
      }

      .btn-primary:hover {
         transform: translateY(-2px);
         box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
         background: #6c757d;
         color: white;
      }

      .btn-secondary:hover {
         background: #5a6268;
      }

      /* Error Messages */
      .field-error {
         color: #dc3545;
         font-size: 0.875rem;
         margin-top: 5px;
         text-align: center;
      }

      /* Mobile button optimizations */
      @media (max-width: 767px) {
         .btn {
            width: 100%;
            margin-right: 0;
            margin-bottom: 10px;
            padding: 16px 20px;
         }

         div[style*="margin-top: 30px"] .btn {
            margin-bottom: 15px;
         }
      }

      /* Current Combination Display */
      .current-combination {
         background: white;
         padding: 20px;
         border-radius: 10px;
         border: 1px solid #e9ecef;
         margin-bottom: 20px;
      }

      .current-combination h3 {
         color: #495057;
         margin-bottom: 15px;
         text-align: center;
      }

      .current-colors {
         display: flex;
         gap: 10px;
         margin-bottom: 10px;
         justify-content: center;
         flex-wrap: wrap;
      }

      .current-color {
         width: 50px;
         height: 50px;
         border-radius: 8px;
         border: 2px solid #e9ecef;
         position: relative;
      }

      .current-color::after {
         content: attr(data-hex);
         position: absolute;
         bottom: -20px;
         left: 50%;
         transform: translateX(-50%);
         font-size: 10px;
         color: #6c757d;
         white-space: nowrap;
      }

      .current-meta {
         color: #6c757d;
         font-size: 0.9rem;
         text-align: center;
      }

      /* Mobile current combination optimizations */
      @media (max-width: 767px) {
         .current-combination {
            padding: 15px;
         }

         .current-colors {
            gap: 8px;
         }

         .current-color {
            width: 40px;
            height: 40px;
         }

         .current-color::after {
            font-size: 8px;
            bottom: -16px;
         }

         .current-meta {
            font-size: 0.85rem;
         }

         .remove-color-btn {
            width: 44px;
            height: 44px;
            font-size: 18px;
         }

         .btn-sm {
            padding: 12px 16px;
            font-size: 15px;
            width: 100%;
            margin-bottom: 10px;
         }
      }

      /* Additional mobile optimizations for edit page */
      @media (max-width: 767px) {
         .color-actions {
            flex-direction: column;
            align-items: center;
            gap: 15px;
         }

         .form-section {
            padding: 15px;
         }
      }

      @media (max-width: 480px) {
         .container {
            margin: 5px;
         }

         .content {
            padding: 15px;
         }

         .current-combination {
            padding: 12px;
         }
      }
   </style>
</head>

<body>
   <div class="container">
      <div class="header">
         <h1>Editar Combinación</h1>
         <p>Modifica los colores y el nombre de tu combinación</p>
      </div>

      <div class="content">
         <!-- Navigation -->
         <div class="nav-back">
            <a th:href="@{/combinations/}">← Volver a combinaciones</a>
         </div>

         <!-- Success/Error Messages -->
         <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
         <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

         <!-- Current Combination Display -->
         <div class="current-combination" th:if="${combination}">
            <h3>Combinación Actual</h3>
            <div class="current-colors">
               <div class="current-color" th:each="color : ${combination.colors}"
                  th:style="'background-color: #' + ${color.hexValue}" th:data-hex="${'#' + color.hexValue}">
               </div>
            </div>
            <div class="current-meta">
               <strong th:text="${combination.name}">Nombre</strong> •
               <span th:text="${combination.colorCount}">2</span> colores •
               Creada el <span
                  th:text="${#temporals.format(combination.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024</span>
            </div>
         </div>

         <!-- Edit Form -->
         <div class="form-section">
            <form th:action="@{/combinations/{id}/update(id=${combination.id})}" method="post"
               th:object="${combinationForm}" id="editForm">

               <!-- Name Field -->
               <div class="form-group">
                  <label for="name">Nombre de la Combinación</label>
                  <input type="text" th:field="*{name}" class="form-control" id="name"
                     placeholder="Ej: Atardecer tropical, Océano profundo..." maxlength="100">
                  <div th:if="${#fields.hasErrors('name')}" class="field-error" th:errors="*{name}"></div>
               </div>

               <!-- Dynamic Color Management -->
               <div class="form-group">
                  <label>Colores de la Combinación</label>
                  <div class="color-count-display">
                     <span id="colorCountDisplay" th:text="${combinationForm.colorCount}">2</span> Colores
                  </div>

                  <div id="dynamicColorFields">
                     <!-- Existing colors will be loaded here -->
                     <div class="color-field" th:each="color, iterStat : *{colors}" th:data-position="${color.position}">
                        <span class="color-label" th:text="'Color ' + ${color.position} + ':'">Color 1:</span>
                        <div class="color-preview" th:id="'preview-' + ${iterStat.index}"></div>
                        <input type="text"
                               th:field="*{colors[__${iterStat.index}__].hexValue}"
                               class="form-control color-input"
                               placeholder="FF5733"
                               maxlength="6"
                               th:data-position="${color.position}"
                               th:data-index="${iterStat.index}">
                        <input type="hidden" th:field="*{colors[__${iterStat.index}__].position}">
                        <button type="button"
                                class="remove-color-btn"
                                th:onclick="'removeExistingColor(' + ${combination.id} + ', ' + ${color.position} + ', this)'"
                                th:disabled="${combinationForm.colorCount == 1}">×</button>
                        <div th:if="${#fields.hasErrors('colors[__' + iterStat.index + '__].hexValue')}"
                             class="field-error" th:errors="*{colors[__${iterStat.index}__].hexValue}"></div>
                     </div>
                  </div>

                  <div class="color-actions">
                     <button type="button" class="btn btn-secondary btn-sm" id="addColorBtn">
                        + Agregar Color
                     </button>
                     <button type="button" class="btn btn-secondary btn-sm" id="addColorAjaxBtn">
                        + Agregar Color (AJAX)
                     </button>
                  </div>
               </div>

               <!-- Live Preview -->
               <div class="live-preview" id="livePreview">
                  <h3>Vista Previa</h3>
                  <div class="preview-combination">
                     <div id="livePreviewColors"></div>
                     <span class="preview-name" id="livePreviewName">Nombre de la combinación</span>
                  </div>
               </div>

               <!-- Action Buttons -->
               <div style="margin-top: 30px;">
                  <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                  <a th:href="@{/combinations/}" class="btn btn-secondary">Cancelar</a>
               </div>
            </form>
         </div>
      </div>
   </div>

   <script>
      document.addEventListener('DOMContentLoaded', function () {
         const nameInput = document.getElementById('name');
         const livePreview = document.getElementById('livePreview');
         const dynamicColorFields = document.getElementById('dynamicColorFields');
         const addColorBtn = document.getElementById('addColorBtn');
         const addColorAjaxBtn = document.getElementById('addColorAjaxBtn');
         const colorCountDisplay = document.getElementById('colorCountDisplay');

         let colorIndex = 1000; // Start high to avoid conflicts with existing colors

         // Initialize previews with current values
         const existingInputs = document.querySelectorAll('.color-input');
         existingInputs.forEach((input, index) => {
            const value = input.value;
            if (value && value.length === 6) {
               updateColorPreview(input.dataset.index, value);
            }
            setupColorInput(input);
         });

         // Initial live preview update
         updateLivePreview();

         // Add color button (form-based)
         addColorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addColorField();
         });

         // Add color button (AJAX-based)
         addColorAjaxBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addColorViaAjax();
         });

         // Add new color field (for form submission)
         function addColorField(hexValue = '') {
            const currentCount = getCurrentColorCount();
            const newPosition = currentCount + 1;
            const fieldIndex = colorIndex++;

            const colorField = document.createElement('div');
            colorField.className = 'color-field';
            colorField.dataset.position = newPosition;
            colorField.innerHTML = `
               <span class="color-label">Color ${newPosition}:</span>
               <div class="color-preview" id="preview-${fieldIndex}"></div>
               <input type="text"
                      name="colors[${currentCount}].hexValue"
                      class="form-control color-input"
                      placeholder="FF5733"
                      maxlength="6"
                      data-position="${newPosition}"
                      data-index="${fieldIndex}"
                      value="${hexValue}">
               <input type="hidden"
                      name="colors[${currentCount}].position"
                      value="${newPosition}">
               <button type="button"
                       class="remove-color-btn"
                       onclick="removeColorField(this)">×</button>
            `;

            dynamicColorFields.appendChild(colorField);

            // Set up event listeners for the new input
            const colorInput = colorField.querySelector('.color-input');
            setupColorInput(colorInput);

            // If hex value provided, update preview
            if (hexValue && hexValue.length === 6) {
               updateColorPreview(fieldIndex, hexValue);
            }

            updateColorCountDisplay();
            updateLivePreview();
         }

         // Add color via AJAX
         function addColorViaAjax() {
            const combinationId = getCombinationId();
            const hexValue = prompt('Ingrese el valor hexadecimal del color (sin #):');

            if (!hexValue) return;

            if (!/^[0-9A-Fa-f]{6}$/.test(hexValue)) {
               alert('Formato inválido. Use 6 caracteres hexadecimales (0-9, A-F)');
               return;
            }

            fetch(`/api/combinations/${combinationId}/colors`, {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify({
                  hexValue: hexValue.toUpperCase(),
                  position: getCurrentColorCount() + 1
               })
            })
            .then(response => response.json())
            .then(data => {
               if (data.success) {
                  alert('Color agregado exitosamente');
                  location.reload(); // Reload to show updated combination
               } else {
                  alert('Error: ' + data.message);
               }
            })
            .catch(error => {
               console.error('Error:', error);
               alert('Error al agregar el color');
            });
         }

         // Remove color field (form-based)
         window.removeColorField = function(button) {
            const colorField = button.closest('.color-field');
            colorField.remove();
            reorderColorFields();
            updateColorCountDisplay();
            updateLivePreview();
         };

         // Remove existing color (AJAX-based)
         window.removeExistingColor = function(combinationId, position, button) {
            if (getCurrentColorCount() <= 1) {
               alert('No se puede eliminar el último color');
               return;
            }

            if (!confirm(`¿Está seguro de eliminar el color en la posición ${position}?`)) {
               return;
            }

            fetch(`/api/combinations/${combinationId}/colors/${position}`, {
               method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
               if (data.success) {
                  alert('Color eliminado exitosamente');
                  location.reload(); // Reload to show updated combination
               } else {
                  alert('Error: ' + data.message);
               }
            })
            .catch(error => {
               console.error('Error:', error);
               alert('Error al eliminar el color');
            });
         };

         // Reorder color fields after removal
         function reorderColorFields() {
            const fields = dynamicColorFields.querySelectorAll('.color-field');
            fields.forEach((field, index) => {
               const position = index + 1;
               const label = field.querySelector('.color-label');
               const hexInput = field.querySelector('input[type="text"]');
               const positionInput = field.querySelector('input[type="hidden"]');

               // Update labels and names
               label.textContent = `Color ${position}:`;
               hexInput.name = `colors[${index}].hexValue`;
               hexInput.dataset.position = position;
               positionInput.name = `colors[${index}].position`;
               positionInput.value = position;
               field.dataset.position = position;
            });
         }

         // Set up color input event listeners
         function setupColorInput(input) {
            input.addEventListener('input', function(e) {
               const value = e.target.value.toUpperCase();
               const isValid = /^[0-9A-F]{0,6}$/.test(value);

               if (isValid) {
                  e.target.value = value;
                  e.target.classList.remove('error');

                  const fieldIndex = e.target.dataset.index;
                  if (value.length === 6) {
                     updateColorPreview(fieldIndex, value);
                  } else {
                     clearColorPreview(fieldIndex);
                  }
               } else {
                  e.target.classList.add('error');
               }

               updateLivePreview();
            });
         }

         // Update color preview
         function updateColorPreview(fieldIndex, hexValue) {
            const preview = document.getElementById(`preview-${fieldIndex}`);
            if (preview) {
               preview.style.backgroundColor = '#' + hexValue;
               preview.style.borderColor = '#' + hexValue;
            }
         }

         // Clear color preview
         function clearColorPreview(fieldIndex) {
            const preview = document.getElementById(`preview-${fieldIndex}`);
            if (preview) {
               preview.style.backgroundColor = '#f8f9fa';
               preview.style.borderColor = '#e9ecef';
            }
         }

         // Get current color count
         function getCurrentColorCount() {
            return dynamicColorFields.querySelectorAll('.color-field').length;
         }

         // Update color count display
         function updateColorCountDisplay() {
            colorCountDisplay.textContent = getCurrentColorCount();
         }

         // Get combination ID from URL
         function getCombinationId() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.indexOf('combinations') + 1];
         }

         // Update live preview
         function updateLivePreview() {
            const name = nameInput.value.trim();
            const colorInputs = dynamicColorFields.querySelectorAll('.color-input');
            const validColors = [];

            colorInputs.forEach(input => {
               const value = input.value.trim();
               if (value.length === 6 && /^[0-9A-F]{6}$/.test(value)) {
                  validColors.push(value);
               }
            });

            if (name && validColors.length > 0) {
               livePreview.style.display = 'block';
               document.getElementById('livePreviewName').textContent = name;

               const previewColorsContainer = document.getElementById('livePreviewColors');
               previewColorsContainer.innerHTML = '';

               validColors.forEach(color => {
                  const colorDiv = document.createElement('div');
                  colorDiv.className = 'preview-color';
                  colorDiv.style.backgroundColor = '#' + color;
                  colorDiv.title = '#' + color;
                  previewColorsContainer.appendChild(colorDiv);
               });
            } else {
               livePreview.style.display = 'none';
            }
         }

         // Name input listener
         nameInput.addEventListener('input', updateLivePreview);

         // Form validation
         document.getElementById('editForm').addEventListener('submit', function (e) {
            const name = nameInput.value.trim();

            if (!name || name.length < 3) {
               e.preventDefault();
               alert('El nombre debe tener al menos 3 caracteres');
               nameInput.focus();
               return;
            }

            const colorInputs = dynamicColorFields.querySelectorAll('.color-input');
            let hasErrors = false;

            colorInputs.forEach((input, index) => {
               const value = input.value.trim();
               if (!value || value.length !== 6 || !/^[0-9A-F]{6}$/.test(value)) {
                  e.preventDefault();
                  alert(`Color ${index + 1} tiene formato inválido. Use 6 caracteres hexadecimales (0-9, A-F)`);
                  input.focus();
                  hasErrors = true;
                  return;
               }
            });

            if (hasErrors) return;
         });
      });
   </script>

   <!-- Mobile Enhancement JavaScript -->
   <script th:src="@{/js/mobile-enhancements.js}"></script>
</body>

</html>
